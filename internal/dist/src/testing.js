"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const java_io_1 = require("java.io");
const java_nio_file_1 = require("java.nio.file");
function walk(file, callback) {
    if (!file.isDirectory()) {
        callback(file);
        return;
    }
    for (const f of file.listFiles()) {
        walk(f, callback);
    }
}
function getTestBaseDir(base) {
    if (!base) {
        return __jsdir;
    }
    if (base[0] === '.') {
        return java_nio_file_1.Paths.get(__jsdir, base).toString();
    }
    const pluginDir = java_nio_file_1.Paths.get(__jsdir, 'plugins', base).toString();
    return pluginDir;
}
async function runTests(base) {
    const baseDir = new java_io_1.File(getTestBaseDir(base));
    const testFiles = [];
    walk(baseDir, (f) => {
        if (!f.getName().match(/\.test\.js$/g) ||
            f.getPath().match('node_modules') // Exclude tests of node_modules
        ) {
            return;
        }
        testFiles.push(f);
    });
    const ownPath = new java_io_1.File(__filename).toPath().getParent();
    testFiles.forEach((f) => {
        const relative = ownPath.relativize(f.toPath());
        require(`./${f.getPath()}`, '.');
    });
    await __zoraHarness.report();
}
async function runner() {
    const env = java.lang.System.getenv('CRAFTJS_ENV');
    console.log(`craftjs_env=${env}`);
    if (env === 'test') {
        runTests();
        try {
            await __zoraHarness.report();
            if (!__zoraHarness.pass) {
                throw new Error();
            }
            java.lang.Runtime.getRuntime().halt(0);
        }
        catch (_a) {
            java.lang.Runtime.getRuntime().halt(1);
        }
    }
}
runner();
global.runTests = runTests;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQStCO0FBQy9CLGlEQUFzQztBQU90QyxTQUFTLElBQUksQ0FBQyxJQUFVLEVBQUUsUUFBOEI7SUFDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUN2QixRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDZixPQUFPO0tBQ1I7SUFDRCxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRTtRQUNoQyxJQUFJLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0tBQ25CO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQWE7SUFDbkMsSUFBSSxDQUFDLElBQUksRUFBRTtRQUNULE9BQU8sT0FBTyxDQUFDO0tBQ2hCO0lBQ0QsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1FBQ25CLE9BQU8scUJBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQzVDO0lBQ0QsTUFBTSxTQUFTLEdBQUcscUJBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNqRSxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsS0FBSyxVQUFVLFFBQVEsQ0FBQyxJQUFhO0lBQ25DLE1BQU0sT0FBTyxHQUFHLElBQUksY0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9DLE1BQU0sU0FBUyxHQUFXLEVBQUUsQ0FBQztJQUM3QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7UUFDbEIsSUFDRSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDO1lBQ2xDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUMsZ0NBQWdDO1VBQ2xFO1lBQ0EsT0FBTztTQUNSO1FBQ0QsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sT0FBTyxHQUFHLElBQUksY0FBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBRTFELFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtRQUN0QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25DLENBQUMsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDL0IsQ0FBQztBQUVELEtBQUssVUFBVSxNQUFNO0lBQ25CLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNsQyxJQUFJLEdBQUcsS0FBSyxNQUFNLEVBQUU7UUFDbEIsUUFBUSxFQUFFLENBQUM7UUFDWCxJQUFJO1lBQ0YsTUFBTSxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDN0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ3ZCLE1BQU0sSUFBSSxLQUFLLEVBQUUsQ0FBQzthQUNuQjtZQUNELElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QztRQUFDLFdBQU07WUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEM7S0FDRjtBQUNILENBQUM7QUFFRCxNQUFNLEVBQUUsQ0FBQztBQUVULE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDIn0=